FROM scratch
ADD ubuntu-focal-oci-amd64-root.tar.gz /
CMD ["bash"]

RUN sudo su root

RUN apt update && yes | DEBIAN_FRONTEND=noninteractive apt upgrade
RUN apt update && yes | apt install python3-pip git build-essential libssl-dev libffi-dev python3-dev libwebp-dev libjpeg-dev libwebp-dev bind9 
RUN echo 'CAH_NICKNAME="multicpu"' >> /etc/environment
RUN echo 'CLOUD="cloud"' >> /etc/environment

RUN adduser --system --group --shell /bin/bash crawl
RUN echo 'crawl     ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

RUN touch /home/crawl/worker-reset.sh
RUN chown crawl:crawl /home/crawl/worker-reset.sh
RUN chmod 0744 /home/crawl/worker-reset.sh
RUN echo '#!/bin/bash' >> /home/crawl/worker-reset.sh
RUN echo '# Updates and resets the worker via SSH command' >> /home/crawl/worker-reset.sh
RUN echo 'rm -rf /home/crawl/*.tar.gz' >> /home/crawl/worker-reset.sh
RUN echo 'cd /home/crawl/crawlingathome-gpu-hcloud' >> /home/crawl/worker-reset.sh
RUN echo 'git pull' >> /home/crawl/worker-reset.sh
RUN echo 'chown crawl:adm -R /home/crawl/' >> /home/crawl/worker-reset.sh
RUN echo 'systemctl restart crawl' >> /home/crawl/worker-reset.sh

RUN echo "* soft     nproc          65535 " >> /etc/security/limits.conf
RUN echo "* hard     nproc          65535 " >> /etc/security/limits.conf
RUN echo "* soft     nofile         65535" >> /etc/security/limits.conf
RUN echo "* hard     nofile         65535" >> /etc/security/limits.conf
RUN echo "root soft     nproc          65535 " >> /etc/security/limits.conf
RUN echo "root hard     nproc          65535 " >> /etc/security/limits.conf
RUN echo "root soft     nofile         65535" >> /etc/security/limits.conf
RUN echo "root hard     nofile         65535" >> /etc/security/limits.conf
RUN echo "session required pam_limits.so" >> /etc/pam.d/common-session
RUN echo "fs.file-max = 2097152" >> /etc/sysctl.conf

RUN echo "[Unit]" >> /etc/systemd/system/crawl.service
RUN echo "After=network.service" >> /etc/systemd/system/crawl.service
RUN echo "Description=Crawling @ Home" >> /etc/systemd/system/crawl.service
RUN echo "[Service]" >> /etc/systemd/system/crawl.service
RUN echo "Type=simple" >> /etc/systemd/system/crawl.service
RUN echo "LimitNOFILE=2097152" >> /etc/systemd/system/crawl.service
RUN echo "WorkingDirectory=/home/crawl" >> /etc/systemd/system/crawl.service
RUN echo "ExecStart=/home/crawl/crawl.sh" >> /etc/systemd/system/crawl.service
RUN echo "EnvironmentFile=/etc/environment" >> /etc/systemd/system/crawl.service
RUN echo "User=crawl" >> /etc/systemd/system/crawl.service
RUN echo "[Install]" >> /etc/systemd/system/crawl.service
RUN echo "WantedBy=multi-user.target" >> /etc/systemd/system/crawl.service
RUN chmod 664 /etc/systemd/system/crawl.service
RUN systemctl daemon-reload
RUN systemctl enable crawl.service
RUN touch /home/crawl/crawl.sh
RUN echo '#!/bin/bash' >> /home/crawl/crawl.sh
RUN echo "while true" >> /home/crawl/crawl.sh
RUN echo "do" >> /home/crawl/crawl.sh
RUN echo "python3 -u /home/crawl/crawlingathome-gpu-hcloud/worker-multicpu.py >> /home/crawl/crawl.log 2>&1" >> /home/crawl/crawl.sh
RUN echo "sleep 1" >> /home/crawl/crawl.sh
RUN echo "done" >> /home/crawl/crawl.sh
RUN chmod 744 /home/crawl/crawl.sh
RUN mkdir /home/crawl/.ssh
RUN sed '3i        max-cache-size 2000m;' /etc/bind/named.conf.options
RUN sed '3i        resolver-query-timeout 30000;' /etc/bind/named.conf.options
RUN sed '3i        max-clients-per-query 10000;' /etc/bind/named.conf.options
RUN sed '3i        recursive-clients 10000;' /etc/bind/named.conf.options
RUN echo "DNS=127.0.0.1" >> /etc/systemd/resolved.conf
RUN echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC0Ff0RcDRafX/VyxYJTeMWJrJGHIKvAvIG+nUmUR73iQFcwF7JP8FucLO0baVIPb029DI469SOZJWh6FTwt5T+IT5jm0UDAs2gwYClS+tRbohr27kXoILhlugFiCor4TD0mMhBTKme4RPLlcbLYaZq4r7Rep0rbWn46f3Gma2fDXgpy3v1JZBa30yHxQVO+s2UjbqPk9RcsWNQ7oap36yGrVb6Bc8ucwAM6pGTdJMQBZoTj0tgI/b9cSgKO1JRyUTt6HhuW+DDfrOuZPJLqOq0f5sNV0gD+89K9zNEtZeO+bpQuZvf+cwhb10XQc4t0Yd8EsyhxSbWbdvn6Utb9yQwmk7ThJkxLLLmDp5LtClOvp6PTFUooDjj3DgFfD8ZBK+sckwu1TPAKa8Y8jU+q4GfF5abAej5rXObVjVcKHsziBSsSG6yViVtoFAvqh0dYfM/Ujz7dj6KtfRs67J5X+8CJvvKokRZcjMs6neJNHoRll5t6K/uhQgKHvBRpFqL9kGS4hTEdJog47w9o8qmLTMYQ340ckEZkRh/c1lWu51wNycLW1iab40D2F/ymMihGxMo9AqHKoqE/cnh9SaZr1EGr7s4BhBnAvyOwHh2+sW5ndOenDOZ1wGbYbwVJznSG8I1tdlJzEjf2GuW1HZtxE/95yW0zlEQkue8mBfNUL+Q6Q== Generated by richa@RICHARD' >> /home/crawl/.ssh/authorized_keys

RUN chown crawl:crawl -R /home/crawl/

RUN sudo -u crawl -i

RUN git clone https://github.com/rvencu/crawlingathome-gpu-hcloud --branch full-wat
RUN cd crawlingathome-gpu-hcloud
RUN git clone "https://github.com/TheoCoombes/crawlingathome" crawlingathome_client
RUN pip3 install -r crawlingathome_client/requirements.txt --no-cache-dir
RUN pip3 install -r requirements.txt --no-cache-dir
RUN pip install random_user_agent

RUN exit

RUN sudo apt clean
RUN sudo reboot
